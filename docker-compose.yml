services:
  db:
    image: postgres:15-alpine
    container_name: cctv-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: cctvdb
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres -d cctvdb" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mediamtx:
    image: bluenviron/mediamtx:latest-ffmpeg
    container_name: cctv-mediamtx
    ports:
      - "8554:8554" # RTSP
      - "1935:1935" # RTMP
      - "8888:8888" # HLS
      - "8889:8889" # WebRTC
      - "8189:8189/udp" # WebRTC ICE/UDP
      - "8557:8557" # API
    volumes:
      - ./mediamtx.yml:/mediamtx.yml:ro
    restart: unless-stopped
    depends_on:
      - coturn

  coturn:
    image: coturn/coturn:latest
    container_name: cctv-coturn
    network_mode: host
    command:
      - -n
      - --lt-cred-mech
      - --fingerprint
      - --no-stdout-log
      - --log-file=stdout
      - --realm=mediamtx
      - --user=mediamtx:mediamtxpassword
      - --external-ip=192.168.0.173
      - --min-port=49152
      - --max-port=65535
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: cctv-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/cctvdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: root
      MEDIAMTX_API_URL: http://mediamtx:8557
      MEDIAMTX_API_USERNAME: admin
      MEDIAMTX_API_PASSWORD: admin
      MEDIAMTX_STREAM_BASE_URL: http://192.168.0.173:8888
      MEDIAMTX_PUBLIC_HOST: "192.168.0.173"
    depends_on:
      db:
        condition: service_healthy
      mediamtx:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 256M

  frontend:
    build: .
    container_name: cctv-frontend
    ports:
      - "3000:8080"
    environment:
      REACT_APP_API_URL: http://192.168.0.173:8080
      REACT_APP_MEDIAMTX_URL: http://192.168.0.173:8888
    depends_on:
      backend:
        condition: service_started
      mediamtx:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

volumes:
  postgres_data:
  hls_data:
